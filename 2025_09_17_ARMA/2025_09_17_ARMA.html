<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-09-17">

<title>2025_09_17 ARMA Processes, lecture notes</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="2025_09_17_ARMA_files/libs/clipboard/clipboard.min.js"></script>
<script src="2025_09_17_ARMA_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="2025_09_17_ARMA_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="2025_09_17_ARMA_files/libs/quarto-html/popper.min.js"></script>
<script src="2025_09_17_ARMA_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="2025_09_17_ARMA_files/libs/quarto-html/anchor.min.js"></script>
<link href="2025_09_17_ARMA_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="2025_09_17_ARMA_files/libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="2025_09_17_ARMA_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="2025_09_17_ARMA_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="2025_09_17_ARMA_files/libs/bootstrap/bootstrap-81267100e462c21b3d6c0d5bf76a3417.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#preliminaries" id="toc-preliminaries" class="nav-link active" data-scroll-target="#preliminaries">Preliminaries</a>
  <ul>
  <li><a href="#load-the-required-libraries" id="toc-load-the-required-libraries" class="nav-link" data-scroll-target="#load-the-required-libraries">Load the required libraries</a></li>
  <li><a href="#set-working-directory" id="toc-set-working-directory" class="nav-link" data-scroll-target="#set-working-directory">Set working directory</a></li>
  </ul></li>
  <li><a href="#arma-processes" id="toc-arma-processes" class="nav-link" data-scroll-target="#arma-processes">ARMA processes</a>
  <ul>
  <li><a href="#autoregressive-ar-process-definition-in-the-non-seasonal-regular-case" id="toc-autoregressive-ar-process-definition-in-the-non-seasonal-regular-case" class="nav-link" data-scroll-target="#autoregressive-ar-process-definition-in-the-non-seasonal-regular-case">Autoregressive (AR) Process Definition in the Non Seasonal (Regular) Case</a>
  <ul class="collapse">
  <li><a href="#backshift-operator-and-characteristic-polynomial" id="toc-backshift-operator-and-characteristic-polynomial" class="nav-link" data-scroll-target="#backshift-operator-and-characteristic-polynomial">Backshift Operator and Characteristic Polynomial</a></li>
  <li><a href="#stationarity-in-ar-processes" id="toc-stationarity-in-ar-processes" class="nav-link" data-scroll-target="#stationarity-in-ar-processes">Stationarity in AR Processes</a></li>
  </ul></li>
  <li><a href="#generating-a-pure-autoregressive-ar2-time-series" id="toc-generating-a-pure-autoregressive-ar2-time-series" class="nav-link" data-scroll-target="#generating-a-pure-autoregressive-ar2-time-series">Generating a pure autoregressive AR(2) time series</a></li>
  <li><a href="#the-acf-and-pacf-of-a-pure-arp-model" id="toc-the-acf-and-pacf-of-a-pure-arp-model" class="nav-link" data-scroll-target="#the-acf-and-pacf-of-a-pure-arp-model">The ACF and PACF of a pure AR(p) model</a></li>
  <li><a href="#fitting-an-arima-model-to-this-time-series" id="toc-fitting-an-arima-model-to-this-time-series" class="nav-link" data-scroll-target="#fitting-an-arima-model-to-this-time-series">Fitting an ARIMA model to this time series</a>
  <ul class="collapse">
  <li><a href="#diagnose-of-the-fit.-coefficients-and-residuals." id="toc-diagnose-of-the-fit.-coefficients-and-residuals." class="nav-link" data-scroll-target="#diagnose-of-the-fit.-coefficients-and-residuals.">Diagnose of the fit. Coefficients and residuals.</a>
  <ul class="collapse">
  <li><a href="#statistical-significance-of-the-model-coefficients-and-stationarity" id="toc-statistical-significance-of-the-model-coefficients-and-stationarity" class="nav-link" data-scroll-target="#statistical-significance-of-the-model-coefficients-and-stationarity">Statistical significance of the model coefficients and stationarity</a></li>
  </ul></li>
  <li><a href="#residual-diagnosis" id="toc-residual-diagnosis" class="nav-link" data-scroll-target="#residual-diagnosis">Residual diagnosis</a></li>
  <li><a href="#graphic-inspection-of-the-fitted-values" id="toc-graphic-inspection-of-the-fitted-values" class="nav-link" data-scroll-target="#graphic-inspection-of-the-fitted-values">Graphic inspection of the fitted values</a></li>
  </ul></li>
  <li><a href="#moving-average-ma-process-definition-in-the-non-seasonal-regular-case" id="toc-moving-average-ma-process-definition-in-the-non-seasonal-regular-case" class="nav-link" data-scroll-target="#moving-average-ma-process-definition-in-the-non-seasonal-regular-case">Moving Average (MA) Process Definition in the Non Seasonal (Regular) Case</a>
  <ul class="collapse">
  <li><a href="#moving-average-processes" id="toc-moving-average-processes" class="nav-link" data-scroll-target="#moving-average-processes">Moving Average Processes</a></li>
  <li><a href="#characteristic-polynomial" id="toc-characteristic-polynomial" class="nav-link" data-scroll-target="#characteristic-polynomial">Characteristic polynomial</a>
  <ul class="collapse">
  <li><a href="#invertibility" id="toc-invertibility" class="nav-link" data-scroll-target="#invertibility">Invertibility</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#generating-a-pure-moving-average-ma2-time-series" id="toc-generating-a-pure-moving-average-ma2-time-series" class="nav-link" data-scroll-target="#generating-a-pure-moving-average-ma2-time-series">Generating a pure moving average MA(2) time series</a></li>
  <li><a href="#the-acf-and-pacf-of-a-pure-maq-model" id="toc-the-acf-and-pacf-of-a-pure-maq-model" class="nav-link" data-scroll-target="#the-acf-and-pacf-of-a-pure-maq-model">The ACF and PACF of a pure MA(q) model</a></li>
  <li><a href="#fitting-an-arima-model-to-this-time-series-1" id="toc-fitting-an-arima-model-to-this-time-series-1" class="nav-link" data-scroll-target="#fitting-an-arima-model-to-this-time-series-1">Fitting an ARIMA model to this time series</a>
  <ul class="collapse">
  <li><a href="#diagnose-of-the-fit." id="toc-diagnose-of-the-fit." class="nav-link" data-scroll-target="#diagnose-of-the-fit.">Diagnose of the fit.</a>
  <ul class="collapse">
  <li><a href="#statistical-significance-of-the-model-coefficients-and-stationarity-1" id="toc-statistical-significance-of-the-model-coefficients-and-stationarity-1" class="nav-link" data-scroll-target="#statistical-significance-of-the-model-coefficients-and-stationarity-1">Statistical significance of the model coefficients and stationarity</a></li>
  </ul></li>
  <li><a href="#residual-diagnosis-1" id="toc-residual-diagnosis-1" class="nav-link" data-scroll-target="#residual-diagnosis-1">Residual diagnosis</a></li>
  <li><a href="#graphic-inspection-of-the-fitted-values-1" id="toc-graphic-inspection-of-the-fitted-values-1" class="nav-link" data-scroll-target="#graphic-inspection-of-the-fitted-values-1">Graphic inspection of the fitted values</a></li>
  </ul></li>
  <li><a href="#definition-of-the-armap-q-process" id="toc-definition-of-the-armap-q-process" class="nav-link" data-scroll-target="#definition-of-the-armap-q-process">Definition of the ARMA(p, q) process</a></li>
  <li><a href="#generatig-an-armap-q-time-series" id="toc-generatig-an-armap-q-time-series" class="nav-link" data-scroll-target="#generatig-an-armap-q-time-series">Generatig an ARMA(p, q) time series</a>
  <ul class="collapse">
  <li><a href="#the-acf-and-pacf-of-an-armap-q-model" id="toc-the-acf-and-pacf-of-an-armap-q-model" class="nav-link" data-scroll-target="#the-acf-and-pacf-of-an-armap-q-model">The ACF and PACF of an ARMA(p, q) model</a></li>
  <li><a href="#exercise" id="toc-exercise" class="nav-link" data-scroll-target="#exercise">Exercise</a></li>
  <li><a href="#arma-hackaton" id="toc-arma-hackaton" class="nav-link" data-scroll-target="#arma-hackaton">ARMA Hackaton</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#converting-dates-from-last-to-first-day-of-the-month-for-eda" id="toc-converting-dates-from-last-to-first-day-of-the-month-for-eda" class="nav-link" data-scroll-target="#converting-dates-from-last-to-first-day-of-the-month-for-eda">Converting dates from <em>last</em> to <em>first</em> day of the month for EDA</a>
  <ul>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">2025_09_17 ARMA Processes, lecture notes</h1>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">September 17, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="do">#####################################################################</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="do">##########       Lab Practice 2:      ARMA models         ###########</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="do">#####################################################################</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="preliminaries" class="level1">
<h1>Preliminaries</h1>
<section id="load-the-required-libraries" class="level3">
<h3 class="anchored" data-anchor-id="load-the-required-libraries">Load the required libraries</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MLTools)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fpp2)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmtest) <span class="co">#contains coeftest function</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="set-working-directory" class="level3">
<h3 class="anchored" data-anchor-id="set-working-directory">Set working directory</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="fu">dirname</span>(rstudioapi<span class="sc">::</span><span class="fu">getActiveDocumentContext</span>()<span class="sc">$</span>path))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="arma-processes" class="level1">
<h1>ARMA processes</h1>
<section id="autoregressive-ar-process-definition-in-the-non-seasonal-regular-case" class="level2">
<h2 class="anchored" data-anchor-id="autoregressive-ar-process-definition-in-the-non-seasonal-regular-case">Autoregressive (AR) Process Definition in the Non Seasonal (Regular) Case</h2>
<p>A stochastic process <span class="math inline">\((Y_t)\)</span> is called <strong>autoregressive</strong> if it satisfies the equation:</p>
<p><span class="math display">\[y_{t} = \phi_{1}y_{t-1} + \phi_{2}y_{t-2} + \dots + \phi_{p}y_{t-p} + \varepsilon_{t},\]</span></p>
<p>where:</p>
<ul>
<li><span class="math inline">\(\varepsilon_{t}\)</span> is gaussian white noise</li>
<li><span class="math inline">\(\phi_1, \ldots, \phi_{p}\)</span> are constants, called the <strong>coefficients</strong> of the process.</li>
<li>The number <span class="math inline">\(p\)</span> is the <strong>order</strong> of the process, which is then called an <strong><span class="math inline">\(AR(p)\)</span> process</strong>.</li>
</ul>
<p>Any time series which is a realization of an autoregressive process is called an <strong>autoregressive time series</strong>.</p>
<p>An autoregressive process can be considered as analogous to a multiple linear regression model. But here the prediction of <span class="math inline">\(y_t\)</span> uses recent lags of the time series as input variables. We regress the time series onto its recent past, and that is why we call it <strong>autoregressive</strong>.</p>
<section id="backshift-operator-and-characteristic-polynomial" class="level4">
<h4 class="anchored" data-anchor-id="backshift-operator-and-characteristic-polynomial">Backshift Operator and Characteristic Polynomial</h4>
<p>Using the <strong>backshift operator</strong> <span class="math display">\[B(y_t) = y_{t - 1}\]</span></p>
<p>we can write the autoregressive process as:</p>
<p><span class="math display">\[\Phi(B) y_t = (1-\phi_1B - \cdots - \phi_p B^p)y_{t} = \varepsilon_{t}\]</span></p>
<p>where</p>
<p><span class="math display">\[\Phi(B) = (1-\phi_1B - \cdots - \phi_p B^p)\]</span> is the <strong>characteristic polynomial</strong> of the process.</p>
</section>
<section id="stationarity-in-ar-processes" class="level4">
<h4 class="anchored" data-anchor-id="stationarity-in-ar-processes">Stationarity in AR Processes</h4>
<p>Not all AR processes are stationary: as we have said, a random walk is an example of AR(1) process, but we know it is not stationary. <strong>An autoregressive AR(p) process is stationary if and only if the roots of the characteristic polynomial are outside the unit circle.</strong></p>
</section>
</section>
<section id="generating-a-pure-autoregressive-ar2-time-series" class="level2">
<h2 class="anchored" data-anchor-id="generating-a-pure-autoregressive-ar2-time-series">Generating a pure autoregressive AR(2) time series</h2>
<p>We will generate a time series following this equation (using the characteristic polynomial formulation): <span class="math display">\[(1 - (1/3)B - (1/2)B^2)y_{t} = \varepsilon_{t}\]</span></p>
<p><strong>White noise as starting point.</strong> We begin creating a gaussian white noise time series. In order to do that we get a sample of n random values from a standard normal.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>w <span class="ot">&lt;-</span> <span class="fu">ts</span>(<span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>))</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(w, <span class="dv">25</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Time Series:
Start = 1 
End = 25 
Frequency = 1 
 [1]  1.37095845 -0.56469817  0.36312841  0.63286260  0.40426832 -0.10612452
 [7]  1.51152200 -0.09465904  2.01842371 -0.06271410  1.30486965  2.28664539
[13] -1.38886070 -0.27878877 -0.13332134  0.63595040 -0.28425292 -2.65645542
[19] -2.44046693  1.32011335 -0.30663859 -1.78130843 -0.17191736  1.21467470
[25]  1.89519346</code></pre>
</div>
</div>
<p>Now we can use a for loop to generate the autoregressive time series:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>phi <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, n)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>y[<span class="dv">1</span>] <span class="ot">&lt;-</span> w[<span class="dv">1</span>]</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>y[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="sc">-</span>phi[<span class="dv">1</span>] <span class="sc">*</span> y[<span class="dv">1</span>] <span class="sc">+</span> w[<span class="dv">2</span>]</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">3</span><span class="sc">:</span>n){</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  y[t] <span class="ot">&lt;-</span> phi[<span class="dv">1</span>] <span class="sc">*</span> y[t <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">+</span> phi[<span class="dv">2</span>] <span class="sc">*</span> y[t <span class="sc">-</span> <span class="dv">2</span>] <span class="sc">+</span> w[t]</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">ts</span>(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To see the first values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(<span class="fu">head</span>(y, <span class="dv">100</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2025_09_17_ARMA_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>And for the autocorrelation information</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggtsdisplay</span>(y, <span class="at">lag.max =</span> <span class="fu">min</span>(n<span class="sc">/</span><span class="dv">5</span>, <span class="dv">50</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2025_09_17_ARMA_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="the-acf-and-pacf-of-a-pure-arp-model" class="level2">
<h2 class="anchored" data-anchor-id="the-acf-and-pacf-of-a-pure-arp-model">The ACF and PACF of a pure AR(p) model</h2>
<ul>
<li><p>Given a time series generated by a pure AR(p) process, trying to identify the value of <span class="math inline">\(p\)</span> in the ACF is not easy. The theoretical ACF of a pure autoregressive process decays exponentially. But the pattern of decay can be complex and besides we only have access to estimated values of the ACF.</p></li>
<li><p>That is the reason for the use of the <strong>PACF. Partial autocorrelation</strong> measures the correlation between lagged values in a time series when we remove the influence of correlated lagged values in between.</p></li>
<li><p>The (theoretical) PACF for a pure autoregressive process AR(p) equals 0 for lags greater than p.&nbsp;In practice that means that in the (estimated) PACF plots <strong>we expect the first p lags to be the only ones significantly different from 0</strong>.</p></li>
<li><p>Keep in mind however that <strong>the ACF and PACF should always be considered jointly</strong> to identify the structure of the process.</p></li>
</ul>
<p>Check this in the PACF above.</p>
</section>
<section id="fitting-an-arima-model-to-this-time-series" class="level2">
<h2 class="anchored" data-anchor-id="fitting-an-arima-model-to-this-time-series">Fitting an ARIMA model to this time series</h2>
<p>Now suppose that you know that the series was generated by an AR(2) process, but you don’t know the coefficients <span class="math inline">\(\phi_1, \phi_2\)</span>.<br>
The <code>Arima</code> function in the forecast library fits a model to the series, using the order p = 2:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Line 32</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit model with estimated order</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>arima.fit <span class="ot">&lt;-</span> <span class="fu">Arima</span>(y, <span class="at">order=</span><span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="at">include.mean =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will discuss below the structure of this function call. The coefficients fitted for this model are <code>ar1, ar2</code> in the output of the next code line:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(arima.fit) <span class="co"># summary of training errors and estimated coefficients</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Series: y 
ARIMA(2,0,0) with zero mean 

Coefficients:
         ar1     ar2
      0.3131  0.4806
s.e.  0.0392  0.0392

sigma^2 = 0.9486:  log likelihood = -695.76
AIC=1397.52   AICc=1397.57   BIC=1410.16

Training set error measures:
                      ME      RMSE       MAE      MPE     MAPE      MASE
Training set -0.04024805 0.9720046 0.7667771 844.0977 1238.059 0.7675081
                     ACF1
Training set -0.003799996</code></pre>
</div>
</div>
<p>And you can see they are not far from the real values.</p>
<section id="diagnose-of-the-fit.-coefficients-and-residuals." class="level3">
<h3 class="anchored" data-anchor-id="diagnose-of-the-fit.-coefficients-and-residuals.">Diagnose of the fit. Coefficients and residuals.</h3>
<section id="statistical-significance-of-the-model-coefficients-and-stationarity" class="level4">
<h4 class="anchored" data-anchor-id="statistical-significance-of-the-model-coefficients-and-stationarity">Statistical significance of the model coefficients and stationarity</h4>
<p>The statistical theory behind the ARIMA model allows us to test if the coefficients of the fitted model are significantly different from zero (the null is <em>the coefficient is 0</em>)</p>
<p>We can do this with the <code>coeftest</code> function</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Line 37</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">coeftest</span>(arima.fit) <span class="co"># statistical significance of estimated coefficients</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
z test of coefficients:

    Estimate Std. Error z value  Pr(&gt;|z|)    
ar1 0.313113   0.039218  7.9839 1.418e-15 ***
ar2 0.480567   0.039235 12.2486 &lt; 2.2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>The small p-values (in the column <code>Pr(&gt;|z|)</code> and indicated by the asterisks) show that this is indeed the case.</p>
<p>Next we check for stationarity, looking at the <strong>inverse values of the roots</strong> of the characteristic polynomial.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Line 39</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(arima.fit) <span class="co"># root plot</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2025_09_17_ARMA_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The <em>inverse</em> values are <em>inside</em> the unit circle, so that is ok.</p>
</section>
</section>
<section id="residual-diagnosis" class="level3">
<h3 class="anchored" data-anchor-id="residual-diagnosis">Residual diagnosis</h3>
<p>The <strong>residuals</strong> of the model are defined as usual <span class="math display">\[
e_t = \hat y_t - y_t
\]</span> If the ARIMA model is a good fit for the time series, these residuals should behave like gaussian white noise.</p>
<p>We can check that with these diagnosis plots:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Line 41</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Check residuals</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="fu">CheckResiduals.ICAI</span>(arima.fit, <span class="at">bins =</span> <span class="dv">100</span>, <span class="at">lags =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2025_09_17_ARMA_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Ljung-Box test

data:  Residuals from ARIMA(2,0,0) with zero mean
Q* = 11.897, df = 8, p-value = 0.1558

Model df: 2.   Total lags used: 10</code></pre>
</div>
</div>
<p>The <strong>Ljung-Box</strong> hypothesis test uses the null hypothesis: <em>the residuals are white noise</em>. So if we get a low p-value that is a symptom of an unsatisfactory Arima fit.</p>
<p>Similar plots are obtained with</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Line 44</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># If residuals are not white noise, change order of ARMA</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggtsdisplay</span>(<span class="fu">residuals</span>(arima.fit), <span class="at">lag.max =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2025_09_17_ARMA_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="graphic-inspection-of-the-fitted-values" class="level3">
<h3 class="anchored" data-anchor-id="graphic-inspection-of-the-fitted-values">Graphic inspection of the fitted values</h3>
<p>We can also examine the fitted vs original time series for a visual check of the model fit:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Line 49</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Check fitted forecast</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(y, <span class="at">series =</span> <span class="st">"Real"</span>) <span class="sc">+</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  forecast<span class="sc">::</span><span class="fu">autolayer</span>(arima.fit<span class="sc">$</span>fitted, <span class="at">series =</span> <span class="st">"Fitted"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2025_09_17_ARMA_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<!-- ```{r} -->
<!-- y_lags <- ts.intersect(y, y_1 = stats::lag(y, 1), y_2 = stats::lag(y, 2)) -->
<!-- head(y_lags) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- y_lm <- tslm(y ~ y_1 + y_2 - 1, data = y_lags) -->
<!-- summary(y_lm) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- CheckResiduals.ICAI(residuals(y_lm)) -->
<!-- ``` -->
</section>
</section>
<section id="moving-average-ma-process-definition-in-the-non-seasonal-regular-case" class="level2">
<h2 class="anchored" data-anchor-id="moving-average-ma-process-definition-in-the-non-seasonal-regular-case">Moving Average (MA) Process Definition in the Non Seasonal (Regular) Case</h2>
<section id="moving-average-processes" class="level3">
<h3 class="anchored" data-anchor-id="moving-average-processes">Moving Average Processes</h3>
<p>A stochastic process <span class="math inline">\((Y_t)\)</span> is called a <strong>moving average</strong> process if it satisfies the equation:</p>
<p><span class="math display">\[y_{t} = \varepsilon_t + \theta_{1}\varepsilon_{t-1} + \theta_{2}\varepsilon_{t-2} + \cdots + \theta_{q}\varepsilon_{t-q},\]</span></p>
<p>where:</p>
<ul>
<li><span class="math inline">\(\varepsilon_{t}\)</span> is gaussian white noise</li>
<li><span class="math inline">\(\theta_1, \ldots, \theta_{q}\)</span> are constants, called the <strong>coefficients</strong> of the process.</li>
<li>The number <span class="math inline">\(q\)</span> is the <strong>order</strong> of the process, which is then called an <strong>MA(q) process</strong>.</li>
</ul>
<p>Any time series which is a realization of a moving average process is called an <strong>moving average time series</strong>.</p>
<p><strong>Note:</strong> we said before that a pure autoregressive process resembles a multilinear regression of the series on its past values. But for pure MA processes this is no longer the case: we can not regress <span class="math inline">\(y_t\)</span> on the past error terms <span class="math inline">\(\varepsilon_{t - k}\)</span> because they are unobservable (the <span class="math inline">\(\theta_k\)</span> are unknown until we fit a model).</p>
</section>
<section id="characteristic-polynomial" class="level3">
<h3 class="anchored" data-anchor-id="characteristic-polynomial">Characteristic polynomial</h3>
<p>The <strong>characteristic polynomial</strong> of the MA(q) process is: <span class="math display">\[
\Theta(B) = 1 + \theta_{1}B + \theta_{2}B^2 + \cdots + \theta_{q}B^q
\]</span> and the MA process can be written as: <span class="math display">\[
y_t = \Theta(B) \varepsilon_t
\]</span></p>
<p>The document <a href="../2025_09_10_StochasticProcess_ARMA/2025_09_10_StochasticProcess_ARMA_files/MA_examples.html">MA_examples</a> deals with real world examples of these kind of processes.</p>
<section id="invertibility" class="level4">
<h4 class="anchored" data-anchor-id="invertibility">Invertibility</h4>
<p>An <span class="math inline">\(MA(q)\)</span> process is invertible if it can be expressed as an autoregressive process <span class="math inline">\(\text{AR}(\infty)\)</span>: <span class="math display">\[
(1 + \theta_1\, B + \theta_1^2\, B^2 + \theta_1^3\, B^2+\dots)y_t = \varepsilon_t
\]</span></p>
<p>MA(q) processes are invertible if <strong>the roots of the characteristic polynomial <span class="math inline">\(\Theta(B)\)</span> are all outside the unit circle of the complex plane.</strong> See the discussion and the video in Section 9.4 of <a href="https://otexts.com/fpp3/MA.html"><span class="citation" data-cites="hyndman2021fpp3">Hyndman &amp; Athanasopoulos (<span>2021</span>)</span></a></p>
</section>
</section>
</section>
<section id="generating-a-pure-moving-average-ma2-time-series" class="level2">
<h2 class="anchored" data-anchor-id="generating-a-pure-moving-average-ma2-time-series">Generating a pure moving average MA(2) time series</h2>
<p>Let us simulate a time series according to the MA(2) characteristic polynomial:</p>
<p><span class="math display">\[y_t = \epsilon_{t} + 0.4\,\epsilon_{t–1} - 0.3\,\epsilon_{t–2} =  (1 + 0.4\,B - 0.3\, B^2)\,\epsilon_{t}\]</span> This is analogous to what we did before for the autoregressive process, assuming that all values before t = 1 are equal to 0.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>w <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>theta <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.4</span>, <span class="sc">-</span><span class="fl">0.3</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co"># theta &lt;- c(0.4, 0)</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, n)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>y[<span class="dv">1</span>] <span class="ot">&lt;-</span> w[<span class="dv">1</span>]</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>y[<span class="dv">2</span>] <span class="ot">&lt;-</span> w[<span class="dv">2</span>] <span class="sc">+</span> theta[<span class="dv">1</span>] <span class="sc">*</span> w[<span class="dv">1</span>] </span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">3</span><span class="sc">:</span>n){</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>  y[t] <span class="ot">&lt;-</span> w[t] <span class="sc">+</span> theta[<span class="dv">1</span>] <span class="sc">*</span> w[t <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">+</span> theta[<span class="dv">2</span>] <span class="sc">*</span> w[t <span class="sc">-</span> <span class="dv">2</span>]</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">ts</span>(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For the first values</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(<span class="fu">head</span>(y, <span class="dv">100</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2025_09_17_ARMA_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>And for the ACF and PACF</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggtsdisplay</span>(y, <span class="at">lag.max =</span> <span class="fu">min</span>(n<span class="sc">/</span><span class="dv">5</span>, <span class="dv">30</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2025_09_17_ARMA_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="the-acf-and-pacf-of-a-pure-maq-model" class="level2">
<h2 class="anchored" data-anchor-id="the-acf-and-pacf-of-a-pure-maq-model">The ACF and PACF of a pure MA(q) model</h2>
<ul>
<li><p>For a time series generated by a pure MA(q) process, the situation is somehow the opposite of what we saw in the AR(p) case. The theoretical ACF becomes zero after q lags, while the PACF decays exponentially. Again the pattern of decay of the PACF can take different forms.</p></li>
<li><p>We emphasize again that for proper identification <strong>the ACF and PACF are to be considered jointly</strong>. For a pure MA(q) process <strong>we expect precisely the first q lags in the ACF to be significantly different from 0, while we observe a pattern of rapid decay in the PACF</strong>.</p></li>
</ul>
</section>
<section id="fitting-an-arima-model-to-this-time-series-1" class="level2">
<h2 class="anchored" data-anchor-id="fitting-an-arima-model-to-this-time-series-1">Fitting an ARIMA model to this time series</h2>
<p>As in the case of the AR example, we can use the <code>Arima</code> function to fit a model to the series, using the order q = 2:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Line 32</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit model with estimated order</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>arima.fit <span class="ot">&lt;-</span> <span class="fu">Arima</span>(y, <span class="at">order=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">2</span>), <span class="at">include.mean =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So you see that the order argument in these examples has the structure <code>order=c(p, 0, q)</code>.</p>
<section id="diagnose-of-the-fit." class="level3">
<h3 class="anchored" data-anchor-id="diagnose-of-the-fit.">Diagnose of the fit.</h3>
<p>We proceed as in the AR case.</p>
<section id="statistical-significance-of-the-model-coefficients-and-stationarity-1" class="level4">
<h4 class="anchored" data-anchor-id="statistical-significance-of-the-model-coefficients-and-stationarity-1">Statistical significance of the model coefficients and stationarity</h4>
<p>With the <code>coeftest</code> function. Note the names of the coefficients.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Line 37</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">coeftest</span>(arima.fit) <span class="co"># statistical significance of estimated coefficients</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
z test of coefficients:

     Estimate Std. Error z value  Pr(&gt;|z|)    
ma1  0.396233   0.030418  13.026 &lt; 2.2e-16 ***
ma2 -0.310509   0.030461 -10.194 &lt; 2.2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>The small p-values again show that the coefficients can be safely assumed to be significantly different from 0.</p>
<p>Next we check for invertibility, looking at the inverse values of the roots of the characteristic polynomial.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Line 39</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(arima.fit) <span class="co"># root plot</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2025_09_17_ARMA_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>They are inside the unit circle, meaning the model is invertible.</p>
</section>
</section>
<section id="residual-diagnosis-1" class="level3">
<h3 class="anchored" data-anchor-id="residual-diagnosis-1">Residual diagnosis</h3>
<p>Using these diagnosis plots:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Line 41</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Check residuals</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="fu">CheckResiduals.ICAI</span>(arima.fit, <span class="at">bins =</span> <span class="dv">100</span>, <span class="at">lags =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2025_09_17_ARMA_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Ljung-Box test

data:  Residuals from ARIMA(0,0,2) with zero mean
Q* = 11.411, df = 8, p-value = 0.1795

Model df: 2.   Total lags used: 10</code></pre>
</div>
</div>
<p>The plots indicate that the residuals behave like gaussian white noise. The Ljung-Box test has a high p-value, so we do not reject the null hypothesis.</p>
</section>
<section id="graphic-inspection-of-the-fitted-values-1" class="level3">
<h3 class="anchored" data-anchor-id="graphic-inspection-of-the-fitted-values-1">Graphic inspection of the fitted values</h3>
<p>We plot the fitted values vs the original time series:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Line 49</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Check fitted forecast</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(y, <span class="at">series =</span> <span class="st">"Real"</span>) <span class="sc">+</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  forecast<span class="sc">::</span><span class="fu">autolayer</span>(arima.fit<span class="sc">$</span>fitted, <span class="at">series =</span> <span class="st">"Fitted"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2025_09_17_ARMA_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="definition-of-the-armap-q-process" class="level2">
<h2 class="anchored" data-anchor-id="definition-of-the-armap-q-process">Definition of the ARMA(p, q) process</h2>
<p>An stochastic process is an <strong>ARMA(p, q) process</strong> if it satisfies the equation <span class="math display">\[
y_{t} = \phi_{1}y_{t-1} + \cdots + \phi_{p}y_{t-p} + \theta_{1}\varepsilon_{t-1} + \cdots + \theta_{q}\varepsilon_{t-q} + \varepsilon_{t}
\]</span> where, as usual, <span class="math inline">\(\varepsilon_{t}\)</span> is white noise, and <span class="math inline">\((p, q)\)</span> are jointly called the order of the process.</p>
<p>The expression of the ARMA(p, q) process in terms of characteristic polynomials is: <span class="math display">\[
\Phi(B)\,y_t = \Theta(B)\varepsilon_t
\]</span> And the process is stationary and invertible if the roots of <strong>both</strong> <span class="math inline">\(\Phi(B)\)</span> and <span class="math inline">\(\Theta(B)\)</span> are outside the complex unit circle.</p>
</section>
<section id="generatig-an-armap-q-time-series" class="level2">
<h2 class="anchored" data-anchor-id="generatig-an-armap-q-time-series">Generatig an ARMA(p, q) time series</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set.seed(42)</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>w <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>phi <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">runif</span>(<span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>), <span class="dv">0</span>)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>theta <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">runif</span>(<span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>), <span class="dv">0</span>)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, n)</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>y[<span class="dv">1</span>] <span class="ot">&lt;-</span> w[<span class="dv">1</span>]</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>y[<span class="dv">2</span>] <span class="ot">&lt;-</span> phi[<span class="dv">1</span>] <span class="sc">*</span> y[<span class="dv">1</span>] <span class="sc">+</span> w[<span class="dv">2</span>] <span class="sc">+</span> theta[<span class="dv">1</span>] <span class="sc">*</span> w[<span class="dv">1</span>] </span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">3</span><span class="sc">:</span>n){</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>  y[t] <span class="ot">&lt;-</span> phi[<span class="dv">1</span>] <span class="sc">*</span> y[t <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">+</span> phi[<span class="dv">2</span>] <span class="sc">*</span> y[t <span class="sc">-</span> <span class="dv">2</span>] <span class="sc">+</span> w[t] <span class="sc">+</span> theta[<span class="dv">1</span>] <span class="sc">*</span> w[t <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">+</span> theta[<span class="dv">2</span>] <span class="sc">*</span> w[t <span class="sc">-</span> <span class="dv">2</span>]</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">ts</span>(y)</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2025_09_17_ARMA_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="the-acf-and-pacf-of-an-armap-q-model" class="level3">
<h3 class="anchored" data-anchor-id="the-acf-and-pacf-of-an-armap-q-model">The ACF and PACF of an ARMA(p, q) model</h3>
<p>Let us examine the ACF and PACF of the ARMA(p, q) time series that we have generated.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggtsdisplay</span>(y, <span class="at">lag.max =</span> <span class="fu">min</span>(n<span class="sc">/</span><span class="dv">5</span>, <span class="dv">30</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="2025_09_17_ARMA_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>As you can see the patterns in the ACF and PACF are harder to analyze, and they basically tell us that this is not a pure AR or MA process. But finding out the order can be complicated, and it is often a matter of trial and error, guided by the diagnosis tools that we have seen above.</li>
<li>Our goal will be to reach a model with <strong>significant coefficients and residuals that look like white noise</strong>.</li>
<li>One basic guideline is <strong>keep it simple!</strong> Sometimes you will feel tempted to start with a fairly complex model, say ARMA(2, 2), and then remove the non significant coefficients. This is not a good idea!</li>
<li>Let us repeat once more: the <strong>ACF and PACF must be considered jointly</strong>. In particular, it is a mistake to think like: “you get p by looking at the PACF and q by looking at the ACF”.</li>
</ul>
</section>
<section id="exercise" class="level3">
<h3 class="anchored" data-anchor-id="exercise">Exercise</h3>
<ul>
<li>Fit and diagnose an ARMA(p, q) model to the series we have generated.</li>
<li>Open the <code>Lab_2_ARMA.R</code> file for today session and try to identify the ARMA order (p, q) for the time series corresponding to each of the columns of the <code>ARMA_series.xls</code> data file.</li>
<li>The fit of an ARMA(p,q) model assumes that the series is generated by an stationary process. In the next session we will address the obvious question: what can be done when the series can not be considered stationary.</li>
</ul>
</section>
<section id="arma-hackaton" class="level3">
<h3 class="anchored" data-anchor-id="arma-hackaton">ARMA Hackaton</h3>
<p>Visit the Moodle section for this chapter.</p>
<!-- ```{r} -->
<!-- acf_tbl <- acf(y, plot = FALSE, lag.max = min(n/5, 30)) -->
<!-- pacf_tbl <- pacf(y, plot = FALSE, lag.max = min(n/5, 30)) -->
<!-- head(acf_tbl) -->
<!-- head(pacf_tbl) -->
<!-- ``` -->
<!-- # Differencing to remove a trend -->
<!-- ```{r} -->
<!-- y <- astsa::gtemp_ocean -->
<!-- autoplot(y) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- ggtsdisplay(y) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- d1y <- diff(y, lag = 1) -->
<!-- d1y -->
<!-- ``` -->
<!-- ```{r} -->
<!-- autoplot(d1y) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- ggtsdisplay(d1y) -->
<!-- ``` -->
</section>
</section>
</section>
<section id="converting-dates-from-last-to-first-day-of-the-month-for-eda" class="level1">
<h1>Converting dates from <em>last</em> to <em>first</em> day of the month for EDA</h1>
<p>This section solves one pending issue from previous sessions, describing an example of the kind of date/time manipulation that is often required when working with time series data.</p>
<p>We load the data in this example, from the file <em>month_final_day.csv</em></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>fdata <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">"month_final_day.csv"</span>, <span class="at">header =</span> <span class="cn">TRUE</span>, <span class="at">sep =</span> <span class="st">","</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(fdata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        date   value
1 1982-01-31 -0.2729
2 1982-02-28 -1.7150
3 1982-03-31 -1.9920
4 1982-04-30 -1.2720
5 1982-05-31  0.3908
6 1982-06-30 -0.1222</code></pre>
</div>
</div>
<p>As you can see we have monthly data but the dates correspond to the last day of the month. That can be hard to deal with because of the irregularity in the length of the months. Therefore we convert it to first day of the month below. This conversion is <strong>purely for exploratoru purposes</strong>. <em>If the precise day of data collection is relevant in any way, you need to be extra cautious when doing this.</em></p>
<p>First we need to acknowledge the format in the file, converting the column into a <code>date</code> object in R:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>fdata<span class="sc">$</span>date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(fdata<span class="sc">$</span>date, <span class="at">format =</span> <span class="st">"%Y-%m-%d"</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(fdata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        date   value
1 1982-01-31 -0.2729
2 1982-02-28 -1.7150
3 1982-03-31 -1.9920
4 1982-04-30 -1.2720
5 1982-05-31  0.3908
6 1982-06-30 -0.1222</code></pre>
</div>
</div>
<p>Now we can use the <code>format</code> function to convert it back to character strings, but with the format of our choice. In the code below we choose to fix the <em>day</em> part of the date as <code>01</code>. But you could try things like `format = “%Y %b” (try it!) to get different results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>fdata<span class="sc">$</span>date <span class="ot">&lt;-</span> <span class="fu">format</span>(fdata<span class="sc">$</span>date, <span class="at">format =</span> <span class="st">"%Y-%m-01"</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fdata$date &lt;- format(fdata$date, format = "%Y %b")</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(fdata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        date   value
1 1982-01-01 -0.2729
2 1982-02-01 -1.7150
3 1982-03-01 -1.9920
4 1982-04-01 -1.2720
5 1982-05-01  0.3908
6 1982-06-01 -0.1222</code></pre>
</div>
</div>
<p>Note however that whatever the format you choose, we have fallen back to strings. So for the rest of the EDA we need to apply <code>as.Date</code> a second time:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>fdata<span class="sc">$</span>date <span class="ot">&lt;-</span> <span class="fu">format</span>(fdata<span class="sc">$</span>date, <span class="at">format =</span> <span class="st">"%Y-%m-%d"</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(fdata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        date   value
1 1982-01-01 -0.2729
2 1982-02-01 -1.7150
3 1982-03-01 -1.9920
4 1982-04-01 -1.2720
5 1982-05-01  0.3908
6 1982-06-01 -0.1222</code></pre>
</div>
</div>
<section id="references" class="level2 unnumbered">


</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" data-line-spacing="2" role="list">
<div id="ref-hyndman2021fpp3" class="csl-entry" role="listitem">
Hyndman, R. J., &amp; Athanasopoulos, G. (2021). <em>Forecasting: Principles and practice</em>. OTexts. Retrieved from <a href="https://otexts.com/fpp3/">https://otexts.com/fpp3/</a>
</div>
<div id="ref-Krispin2019" class="csl-entry" role="listitem">
Krispin, R. (2019). <em>Hands-on time series analysis with r: Perform time series analysis and forecasting using r</em>. Packt Publishing Ltd. Retrieved from <a href="https://github.com/PacktPublishing/Hands-On-Time-Series-Analysis-with-R">https://github.com/PacktPublishing/Hands-On-Time-Series-Analysis-with-R</a>
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>